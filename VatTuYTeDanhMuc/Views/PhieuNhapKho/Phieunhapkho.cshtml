@model PhieuNhapKhoModel
@{
    webContext context = new webContext();
    string ht = GetLocalIPAddress();
    List<NhaCungCap> getListNCC(){
        return context.NhaCungCap.Where(x=>x.Active==true).ToList();
    }

    List<HangHoa> getListHH(){
        return context.HangHoa.Where(x=>x.Active==true).ToList();
    }

    var a = context.ChiTietPhieuNhap.Select(x => x.SoLo).Distinct().ToList();

    string format(Double? a)
    {
        return a?.ToString("N", System.Globalization.CultureInfo.InvariantCulture);
    }
    string GetLocalIPAddress()
    {
        var host = Dns.GetHostEntry(Dns.GetHostName());
        foreach (var ip in host.AddressList)
        {
            if (ip.AddressFamily == AddressFamily.InterNetwork)
            {
                return ip.ToString();
            }
        }
        throw new Exception("No network adapters with an IPv4 address in the system!");
    }

}

<div class="card">
    <div class="card-body">

        <!-- Bordered Tabs Justified -->
        <ul class="nav nav-tabs nav-tabs-bordered d-flex" id="borderedTabJustified" role="tablist">
            <li class="nav-item flex-fill" role="presentation">
                <button class="nav-link w-100 active" id="home-tab" data-bs-toggle="tab" data-bs-target="#bordered-justified-home" type="button" role="tab" aria-controls="home" aria-selected="true">Phiếu nhập kho</button>
            </li>
            <li class="nav-item flex-fill" role="presentation">
                <button class="nav-link w-100" id="profile-tab" data-bs-toggle="tab" data-bs-target="#bordered-justified-profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Nội dung phiếu nhập</button>
            </li>

        </ul>
        <form  action="/them-phieu-nhap" enctype="multipart/form-data" method="post" class="tab-content pt-2" id="borderedTabJustifiedContent">
            <div class="tab-pane fade show active" id="bordered-justified-home" role="tabpanel" aria-labelledby="home-tab">
                <div class="form-group  p-2 mb-2" style="border-radius: 5px; border: 1px solid black; background-color: lightgrey;">
                    <div class="row mb-2">
                        <label class="col-sm-1 col-lg-1 col-form-label">Số phiếu</label>
                        <div class="col-sm-2 col-lg-2">
                            <input type="text" class="form-control" name="@nameof(Model.phieuNhap.SoHd)" id="inputText">
                        </div>
                        <label class="col-sm-1 col-lg-1 col-form-label">Nhà CC</label>
                        <div class="col-sm-5 col-lg-5">
                            <select name="@nameof(Model.phieuNhap.Idncc)" id="nhaCC" class="form-select">
                                <option selected value="0"></option>
                                @foreach (NhaCungCap n in getListNCC())
                                {
                                        <option value="@n.MaNcc">@n.TenNcc</option>
                                }
                            </select>
                        </div>
                        <label class="col-sm-1 col-lg-1 col-form-label">Ng.Nhập</label>
                        <div class="col-sm-2 col-lg-2">
                            <input type="text" name="@nameof(Model.phieuNhap.NgayTao)" value="@DateTime.Now.ToString("dd-MM-yyyy HH:mm")" placeholder="dd-MM-yyyy" class="form-control" id="NgayNhap">
                        </div>
                    </div>
                    <div class="row">
                        <label class="col-sm-1 col-lg-1 col-form-label">Số HĐ</label>
                        <div class="col-sm-2 col-lg-2">
                            <input type="text" name="@nameof(Model.phieuNhap.SoHd)" class="form-control" id="inputText">
                        </div>
                        <label class="col-sm-1 col-lg-1 col-form-label">Ngày HĐ</label>
                        <div class="col-sm-2 col-lg-2">
                            <input type="text" name="@nameof(Model.phieuNhap.NgayHd)" class="form-control" value="@DateTime.Now.ToString("dd-MM-yyyy")" placeholder="dd-MM-yyyy" id="NgayHD">
                        </div>
                        <label class="col-sm-1 col-lg-1 col-form-label">Ghi chú</label>
                        <div class="col-sm-5 col-lg-5">
                            <textarea rows="1" name="@nameof(Model.phieuNhap.GhiChu)" class="form-control"></textarea>
                        </div>
                    </div>
                </div>
                <div class="form-group p-2 mb-2" id="groupTTChiTiet" style="border-radius: 5px; border: 1px solid black;">
                 <div class="row">
                    <label class="col-sm-1 col-lg-1 col-form-label">Tên hàng</label>
                  <div class="col-md-5 mb-2 col-lg-5">
                      <select id="selectHH" onchange="loadDVT()" class="form-select">
                        <option selected disabled value="0">Tên hàng hóa</option>
                        @foreach(HangHoa h in getListHH()){
                        <option value="@h.Id">@h.TenHh</option>
                        }
                      </select>
                  </div>
                  <label class="col-sm-1 col-lg-1 col-form-label">Số lô</label>
                      <div class="col-md-2 mb-2 col-lg-2">
                          <select id="SoLo" class="form-select">
                            <option selected disabled value="0"></option>
                                @foreach (string s in a)
                                {
                                        <option value="@s">@s</option>
                                }
                          </select>
                     </div>
                  <label class="col-sm-1 col-lg-1 col-form-label">ĐV tính</label>
              <div class="col-sm-2 col-lg-2">
                  <input type="text" class="form-control" id="DVT" readonly placeholder="Đơn vị tính">
              </div>

            </div>
                    <div class="row">
                     <label class="col-sm-1 col-lg-1 col-form-label">VAT</label>
                     <div class="col-md-2 mb-2 col-lg-2">
                          <select id="ThueXuat" class="form-select">
                            <option selected disabled>Thuế suất</option>
                            <option value="0">0</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                            <option value="25">25</option>
                            <option value="30">30</option>
                          </select>
                      </div>
                      <label class="col-sm-1 col-lg-1 col-form-label">Số lượng</label>
                      <div class="col-md-2 mb-2 col-lg-2">
                          <input type="text" class="form-control" oninput="inputSLHH()" id="SLHH" placeholder="Số lượng">
                      </div>
                      <label class="col-sm-1 col-lg-1 col-form-label">Đơn giá</label>
                      <div class="col-md-2 mb-2 col-lg-2">
                          <input type="text" class="form-control" oninput="inputDoGia()" id="DonGia" placeholder="Đơn giá">
                      </div>
                      <label class="col-sm-1 col-lg-1 col-form-label">Th.Tiền</label>
                      <div class="col-md-2 mb-2 col-lg-2">
                          <input type="text" class="form-control" oninput="inputThanhTien()" id="ThanhTien" placeholder="Thành tiền">
                      </div>
                    </div>
                    <div class="row">
                      <label class="col-sm-1 col-lg-1 col-form-label">%CKTM</label>
                      <div class="col-md-2 mb-2 col-lg-2">
                          <input type="text"  class="form-control" id="ChietKhau" placeholder="Chiếc khấu">
                      </div>
                      <label class="col-sm-1 col-lg-1 col-form-label">HSX</label>
                      <div class="col-md-2 mb-2 col-lg-2">
                          <input type="text" placeholder="dd-mm-yyyy" value="@DateTime.Now.ToString("dd-MM-yyyy")" class="form-control" id="HanDung">
                      </div>
                      <label class="col-sm-1 col-lg-1 col-form-label">NSX</label>
                      <div class="col-md-2 mb-2 col-lg-2">
                          <input type="text" placeholder="dd-mm-yyyy" value="@DateTime.Now.ToString("dd-MM-yyyy")" class="form-control" id="NgaySX">
                      </div>
                      <div class="col-md-3 mb-2 col-lg-3 d-flex justify-content-end">
                         <button class="btn btn-primary" onclick="addChiTietPhieu()" type="button">Thêm </button>
                      </div>
                    </div>
            </div>
            </div>
                <div class="table-group" style="height: 400px; overflow: auto;">
                    <table class="table table-bordered table-hover table-striped text-center" id="tableChiTietPhieuNhap">
                        <thead style="position: sticky; top: 0;">
                            <tr>
                                <th>Tên biệt dược, hàng hóa</th>
                                <th>ĐVT</th>
                                <th>Số lô</th>
                                <th>Số lượng</th>
                                <th>Đơn giá</th>
                                <th>Thành tiền</th>
                                <th>%CK</th>
                                <th>Hạn dùng</th>
                                <th>Ngày SX</th>
                                <th>Thuế suất</th>
                                <th>Giá bán</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                                <th>...</th>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="form-group p-2 mb-2" style="border-radius: 5px; border: 1px solid black;">
                    <div class="row">
                        <label class="col-sm-1 col-lg-1 col-form-label">Tiền hàng</label>
                        <div class="col-md-2 col-lg-2">
                            <input type="text" class="form-control" readonly id="TienHang" placeholder="Tiền hàng">
                        </div>
                        <label class="col-sm-1 col-lg-1 col-form-label">Tiền CK</label>
                        <div class="col-md-2 col-lg-2">
                            <input type="text" class="form-control" readonly id="TienCK" placeholder="Tiền chiết khấu">
                        </div>
                        <label class="col-sm-1 col-lg-1 col-form-label">Tiền thuế</label>
                        <div class="col-md-2 col-lg-2">
                            <input type="text" class="form-control" readonly id="TienThue" placeholder="Tiền thuế">
                        </div>
                        <label class="col-sm-1 col-lg-1 col-form-label">Th.Toán</label>
                        <div class="col-md-2 col-lg-2">
                            <input type="text" class="form-control" readonly id="TienThanhToan" placeholder="Thanh toán">
                        </div>
                    </div>
                </div>  
            </form>
        <div class="tab-pane fade" id="bordered-justified-profile" role="tabpanel" aria-labelledby="profile-tab">
                Nesciunt totam et. Consequuntur magnam aliquid eos nulla dolor iure eos quia. Accusantium distinctio omnis et atque fugiat. Itaque doloremque aliquid sint quasi quia distinctio similique. Voluptate nihil recusandae mollitia dolores. Ut laboriosam voluptatum dicta.
        </div>
                </div>
            </div>
            <div class="tab-pane fade" id="bordered-justified-profile" role="tabpanel" aria-labelledby="profile-tab">
                 <table id="example" class="table table-striped table-hover text-center display nowrap" style="width:100%">
                    <thead>
                        <tr>
                            <th class="text-center">ID hàng hóa</th>
                            <th  class="text-center">Số lượng</th>
                            <th  class="text-center">Đơn giá</th>
                            <th  class="text-center">Số lô</th>
                            <th  class="text-center">Ngày SX</th>
                            <th  class="text-center">Hạn dùng</th>
                            <th  class="text-center">Chiết khấu</th>
                            <th  class="text-center">VAT</th>
                            <th  class="text-center">Tùy chọn</th>
                        </tr>
                    </thead>
                    <tbody>

                        <tr>
                            <td>HHC01</td>
                            <td>12</td>
                            <td>12.000</td>
                            <td>1</td>
                            <td>22/02/2001</td>
                            <td>22/02/2022</td>
                            <td>10%</td>
                            <td>10%</td>
                            <td>
                                <a href="PhieuNhapKhoPDF" class="btn btn-outline-success">In</a>
                                <a href="#" class="btn btn-outline-primary mx-1">Xem</a>
                                <a href="#" class="btn btn-outline-secondary">Sửa</a>
                                <a href="#" class="btn btn-outline-danger mx-1">xóa</a>
                            </td>
                        </tr>


                    </tbody>
                </table>
            </div>

        </div>

</div>
<script>
    function loadDVT() {
      var idHH = $('#selectHH').val();
            $.ajax({
                        type: "post",
                        url: "/getDonViTinh",
                        data: "idHH=" + idHH,
                        success: function (result) {
                            $('#DVT').val(result.tenDVT);
                            $('#GiaBan').val(toDecimal(result.giaBan));
                        },
                        error: function () {
                            alert("Fail");
                        }
                    });
    };
    function inputSLHH(){
        var thanhTien = $('#ThanhTien').val();
        var SL = $('#SLHH').val();
        var DonGia = toDecimal(getValue(thanhTien)/getValue(SL));
        if(checkNumber(DonGia)){
            $('#DonGia').val(DonGia);
        }
    };
    function inputDoGia(){
        var SL  = $('#SLHH').val();
        var DonGia = $('#DonGia').val();
        var thanhTien = toDecimal(getValue(DonGia)*getValue(SL));
        if(checkNumber(thanhTien)){
            $('#ThanhTien').val(thanhTien);
        }
    };
    function inputThanhTien(){
        var SL  = $('#SLHH').val();
        var thanhTien = $('#ThanhTien').val();
        var DonGia = toDecimal(getValue(thanhTien)/getValue(SL));
        if(checkNumber(DonGia)){
            $('#DonGia').val(DonGia);
        }
    }
    $('#ChietKhau').on('input',function(){
        if(getValue(this.value)>100){
            $(this).val('');
            alert('Chiết khấu không quá 100%');
        }
    });
    function getValue(str){
       return Number(str.replace(/[^0-9.-]+/g,""));
    }
    function checkNumber(str) {
        return /[0-9,.\-$]+/.test(str);
    }
    $('#SLHH,#ThanhTien,#DonGia,#GiaBan,#ChietKhau').on('blur', format);
    function format(){
    if(checkNumber(this.value)){
        const value = this.value.replace(/,/g, '');
        this.value = parseFloat(value).toLocaleString('en-US', {
        style: 'decimal',
            maximumFractionDigits: 2,
            minimumFractionDigits: 2
            })
    }
    }
    function toDecimal(str){
       return parseFloat(str).toLocaleString('en-US', {
                        style: 'decimal',
                        maximumFractionDigits: 2,
                        minimumFractionDigits: 2
        });
    }
    function addChiTietPhieu(){
        var idHH = $('#selectHH').val();
        var SoLo = $('#SoLo').val();
        var ThueXuat = $('#ThueXuat').val();
        var SL = getValue($('#SLHH').val());
        var DonGia = getValue($('#DonGia').val());
        var ThanhTien = getValue($('#ThanhTien').val());
        var ChietKhau = getValue($('#ChietKhau').val());
        var HanDung = $('#HanDung').val();
        var ngaySX = $('#NgaySX').val();
        console.log()
        $.ajax({
                        type: "post",
                        url: "/add-Chi-Tiet-Phieu",
                        data: "idHH=" + idHH + "&SoLo=" + SoLo + "&ThueXuat=" 
                        + ThueXuat + "&SL=" + SL + "&DonGia=" + DonGia + "&ThanhTien=" + ThanhTien 
                        + "&ChietKhau=" + ChietKhau + "&HanDung=" + HanDung + "&NgaySX=" + ngaySX 
                        ,
                        success: function (result) {
                            $('#tableChiTietPhieuNhap').replaceWith(result.table);
                            $('#TienHang').val(toDecimal(result.tienHang));
                            $('#TienCK').val(toDecimal(result.tienCK));
                            $('#TienThue').val(toDecimal(result.tienThue));
                            $('#TienThanhToan').val(toDecimal(result.tienThanhToan));

                            editChitietPhieuNhapTam(0);
                        },
                        error: function () {
                            alert("Fail");
                        }
                    });
    }
    function editChitietPhieuNhapTam(id){
         $.ajax({
              type: "post",
                        url: "/editChitietPhieuNhapTam",
                        data: "id=" + id,
                        success: function (result) {
                            $('#groupTTChiTiet').replaceWith(result);
                        },
                        error: function () {
                            alert("Fail");
                        }
                    });
    }
    function editChiTietPhieu(id){
        var idHH = $('#selectHH').val();
        var SoLo = $('#SoLo').val();
        var ThueXuat = $('#ThueXuat').val();
        var SL = getValue($('#SLHH').val());
        var DonGia = getValue($('#DonGia').val());
        var ThanhTien = getValue($('#ThanhTien').val());
        var ChietKhau = getValue($('#ChietKhau').val());
        var HanDung = $('#HanDung').val();
        var ngaySX = $('#NgaySX').val();
        $.ajax({
                        type: "post",
                        url: "/edit-Chi-Tiet-Phieu",
                        data: "idHH=" + idHH + "&SoLo=" + SoLo + "&ThueXuat=" 
                        + ThueXuat + "&SL=" + SL + "&DonGia=" + DonGia + "&ThanhTien=" + ThanhTien 
                        + "&ChietKhau=" + ChietKhau + "&HanDung=" + HanDung + "&NgaySX=" + ngaySX + "&id=" + id
                        ,
                        success: function (result) {
                            $('#tableChiTietPhieuNhap').replaceWith(result.table);
                            $('#TienHang').val(toDecimal(result.tienHang));
                            $('#TienCK').val(toDecimal(result.tienCK));
                            $('#TienThue').val(toDecimal(result.tienThue));
                            $('#TienThanhToan').val(toDecimal(result.tienThanhToan));

                            editChitietPhieuNhapTam(0);
                        },
                        error: function () {
                            alert("Fail");
                        }
                    });
    }
    function deletePhieuNhapTam(id){
        if(confirm("Bạn có muốn xoá nội dung này")){
            $.ajax({
                        type: "post",
                        url: "/delete-Chi-Tiet-Phieu",
                        data: "id="+id,
                        success: function (result) {
                            $('#tableChiTietPhieuNhap').replaceWith(result.table);
                            $('#TienHang').val(toDecimal(result.tienHang));
                            $('#TienCK').val(toDecimal(result.tienCK));
                            $('#TienThue').val(toDecimal(result.tienThue));
                            $('#TienThanhToan').val(toDecimal(result.tienThanhToan));
                        },
                        error: function () {
                            alert("Fail");
                        }
                    });
        }
    }
</script>
