@model PhieuTraNoModel
@{
  webContext context = new webContext();
  string ht = GetLocalIPAddress();
  List<NhaCungCap> getListNCC = context.NhaCungCap.Where(x => x.Active == true).ToList();
  List<NganHang> getListNH = context.NganHang.Where(x => x.Active == true).ToList();

  //List<NccNganHang> getListNHNCC(int ncc)
  //{
  //  List<NccNganHang> tkk = context.NccNganHang.Where(a => a.Idncc == ncc).ToList();
  //  if (tkk != null) return tkk;
  //  else return null;
  //}


  List<HangHoa> getListHH = context.HangHoa.Where(x => x.Active == true).ToList();

  var a = context.ChiTietPhieuNhap.Select(x => x.SoLo).Distinct().ToList();

  string format(Double? a)
  {
    return a?.ToString("N", System.Globalization.CultureInfo.InvariantCulture);
  }
  string GetLocalIPAddress()
  {
    var host = Dns.GetHostEntry(Dns.GetHostName());
    foreach (var ip in host.AddressList)
    {
      if (ip.AddressFamily == AddressFamily.InterNetwork)
      {
        return ip.ToString();
      }
    }
    throw new Exception("No network adapters with an IPv4 address in the system!");
  }
  string getSoPhieu()
  {
    QuyDinhMa qd = context.QuyDinhMa.Find(1);
    //ID chi nhánh
    string cn = User.Claims.ElementAt(4).Value;

    DateTime d = DateTime.Now;
    string ngayThangNam = d.ToString("yyMMdd");
    string SoPhieu = cn + "_" + qd.TiepDauNgu + ngayThangNam;
    var list = context.SoThuTu.FromSqlRaw("select*from SoThuTu where '" + DateTime.Now.ToString("yyyy-MM-dd") + "' = Convert(date,ngay) and Loai = 'NhapKho'").FirstOrDefault();
    int stt;
    if (list == null)
    {
      SoThuTu sttt = new SoThuTu();
      sttt.Ngay = DateTime.ParseExact(DateTime.Now.ToString("dd-MM-yyyy"), "dd-MM-yyyy", CultureInfo.InvariantCulture);
      sttt.Stt = 0;
      sttt.Loai = "NhapKho";
      context.SoThuTu.Add(sttt);
      context.SaveChanges();
      stt = 1;
    }
    else
    {
      stt = (Int32)list.Stt + 1;
    }
    SoPhieu += stt;
    while (true)
    {
      if (qd.DoDai == SoPhieu.Length) break;
      SoPhieu = SoPhieu.Insert(SoPhieu.Length - stt.ToString().Length, "0");
    }
    return SoPhieu;
  }
  List<PhieuNhap> getListPhieuNhap()
  {
    var list = context.PhieuNhap
    .FromSqlRaw("select*from PhieuNhap where CONVERT(date,NgayTao) = '" + DateTime.Now.ToString("yyyy-MM-dd") + "' and Active = 1")
    .Include(x => x.IdnccNavigation)
    .Include(x => x.IdnvNavigation)
    .OrderByDescending(x => x.Id)
    .ToList();
    return list;
  }
  string dayToString(DateTime? a)
  {
    if (a == null)
    {
      return "";
    }
    return a.Value.ToString("dd-MM-yyyy");
  }

}






<div class="card">
  <div class="card-body">
    <ul class="nav nav-tabs nav-tabs-bordered d-flex" id="borderedTabJustified" role="tablist">
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100 active" id="home-tab" data-bs-toggle="tab" data-bs-target="#bordered-justified-home" type="button" role="tab" aria-controls="home" aria-selected="true">Phiếu trả nợ</button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" id="profile-tab" data-bs-toggle="tab" data-bs-target="#bordered-justified-profile" type="button" role="tab" aria-controls="profile" aria-selected="false">Nhật ký trả nợ</button>
      </li>
      <li class="nav-item flex-fill" role="presentation">
        <button class="nav-link w-100" id="contact-tab" data-bs-toggle="tab" data-bs-target="#bordered-justified-contact" type="button" role="tab" aria-controls="contact" aria-selected="false">Báo cáo nợ</button>
      </li>
    </ul>
    <div class="tab-content pt-2">
      <div class="tab-pane fade show active" id="bordered-justified-home" role="tabpanel" aria-labelledby="home-tab">
        <div class="row justify-content-start mb-2">
          <div class="col-lg-2 col-sm-2 pl-0">
            <input class="form-control" type="text" id="fromDay" value="" placeholder="Từ ngày">
          </div>
          <div class="col-lg-2 col-sm-2">
            <input class="form-control" type="text" id="toDay" value="" placeholder="Tới ngày">
          </div>
          <div class="col-sm-3 col-lg-3">
            <select required name="@nameof(Model.phieuTraNo.Idncc)" id="nhaCC1" onchange="getNHNCC()" class="form-select2">
              <option selected value=""></option>
              @foreach (NhaCungCap n in getListNCC)
              {
                <option value="@n.Id">@n.TenNcc</option>
              }
            </select>
          </div>
          <div class="col-lg-1 col-sm-1">
            <button type="button" class="btn btn-secondary"><i class="bi bi-search"></i></button>
          </div>
        </div>
        <div>
          <table id="tableChiTietPhieuNhap" class="table table-striped table-hover text-center display nowrap" style="width:100%">
            <thead>
              <tr>
                <th class="text-center">Số phiếu</th>
                <th class="text-center">Ngày thanh toán</th>
                <th class="text-end">Tổng cộng</th>
                <th class="text-end">Đã thanh toán</th>
                <th class="text-end">Còn lại</th>
                <th class="text-end">Thanh toán</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td><input type="text" /></td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="form-group p-2 mb-2" style="border-bottom: solid 2px black">

          <div class="row mb-2" style=" --bs-gutter-x: 0.5rem;">
            <label class="col-sm-2 col-lg-2 col-form-label">Tổng tiền thanh toán</label>
            <div class="col-md-2 col-lg-2">
              <input type="text" class="form-control" readonly="" id="Tongtien" placeholder="Tổng tiền">
            </div>
            <label class="col-sm-2 col-lg-2 col-form-label">Ngày thanh toán</label>
            <div class="col-md-2 col-lg-2">
              <input class="form-control" type="text" id="toDay" value="" placeholder="Ngày thanh toán">
            </div>
            <label class="col-sm-2 col-lg-2 col-form-label">Hình thức thanh toán</label>
            <div class="col-md-2 col-lg-2">
              <select required onchange="" name="" id="httt" class="form-select2">
                <option selected value="">Hình thức</option>
                <option value="n" label=""></option>
              </select>
            </div>

          </div>
          <div class="row nhncc" style=" --bs-gutter-x: 0.5rem;">
            <label class="col-sm-2 col-lg-2 col-form-label">Ngân hàng</label>
            <div class="col-md-2 col-lg-2">
              <select required name="@nameof(Model.nccNganHang.Idnh)" id="nganhang" class="form-select">
                <option selected value=""></option>
                @*//load sau khi chọn*@
              </select>
            </div>
            <label class="col-sm-1 col-lg-1 col-form-label">Người nhận</label>
            <div class="col-md-3 col-lg-3">
              <input type="text" class="form-control" readonly="" id="nguoinhan" placeholder="Người nhận">
            </div>
            <label class="col-sm-1 col-lg-1 col-form-label">Ghi chú</label>
            <div class="col-md-3 col-lg-3">
              <textarea rows="1" name="GhiChu" class="form-control"></textarea>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="d-flex justify-content-end">
            <button class="btn btn-primary" type="submit">Lưu</button>
          </div>
        </div>
      </div>


      @* tabcontrol 2 *@
      <div class="tab-pane fade" id="bordered-justified-profile" role="tabpanel" aria-labelledby="profile-tab">
        <div class="row justify-content-start mb-2">
          <div class="col-lg-2 col-sm-2 pl-0">
            <input class="form-control" type="text" id="fromDay" value="" placeholder="Từ ngày">
          </div>
          <div class="col-lg-2 col-sm-2">
            <input class="form-control" type="text" id="toDay" value="" placeholder="Tới ngày">
          </div>
          <div class="col-sm-3 col-lg-3">
            <select required onchange="" name="" id="Nhacc" class="form-select2">
              <option selected value="">nhà cung cấp</option>
              <option value="nhà cung cấp" label="nhà cung cấp"></option>
            </select>
          </div>
          <div class="col-lg-1 col-sm-1">
            <button type="button" class="btn btn-secondary"><i class="bi bi-search"></i></button>
          </div>
          <div class="ml-4" style="display: contents">
            <button value="2" class="col-lg-2 col-sm-2 btn btn-success" style=" margin-left: 15.5%;" id="in">In</button>
          </div>
        </div>
        <div>
          <table id="tableChiTietPhieuNhap" class="table table-striped table-hover text-center display nowrap" style="width:100%">
            <thead>
              <tr>
                <th class="text-center">Số phiếu</th>
                <th class="text-center">Ngày thanh toán</th>
                <th class="text-end">Số tiền</th>
                <th class="text-center">Hình thức TT</th>
                <th class="text-center">Ngân hàng</th>
                <th class="text-center">Người nhận</th>
                <th class="text-start">Ghi chú</th>
                <th class="text-center">Tùy chọn</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td>...</td>

                <td style="text-align:center">
                  <button value="2" class="edit btn btn-success" style="margin-right: 5px" id="in1">In</button>
                  <button value="2" class="remove btn btn-danger">Bỏ</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      @* tabcontrol 3*@
      <div class="tab-pane fade" id="bordered-justified-contact" role="tabpanel" aria-labelledby="contact-tab">
        <div class="row justify-content-start mb-2">
          <div class="col-lg-2 col-sm-2 pl-0">
            <input class="form-control" type="text" id="fromDay" value="" placeholder="Từ ngày">
          </div>
          <div class="col-lg-2 col-sm-2">
            <input class="form-control" type="text" id="toDay" value="" placeholder="Tới ngày">
          </div>
          <div class="col-lg-1 col-sm-1">
            <button type="button" class="btn btn-secondary"><i class="bi bi-search"></i></button>
          </div>
        </div>
        <div>
          <table id="tableChiTietPhieuNhap" class="table table-striped table-hover text-center display nowrap" style="width:100%">
            <thead>
              <tr>
                <th class="text-center">Mã NCC</th>
                <th class="text-start">Tên NCC</th>
                <th class="text-end">Nợ cũ</th>
                <th class="text-end">Nợ mới</th>
                <th class="text-end">Tổng nộ</th>
                <th class="text-center">Tùy chọn</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td>...</td>
                <td style="text-align:center">
                  <button value="2" class="edit btn btn-success" style="margin-right: 5px" id="in1">In</button>
                  <button value="2" class="remove btn btn-primary">Xem</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>



<script>

  function getNHNCC() {
    var idncc = $('#nhaCC1').val();
   // alert(idncc);
    $.ajax({
      type: "post",
      url: "/getNganHangNCC",
      data: "idncc=" + idncc,
      success: function (result) {
        //alert(idncc);
        //$('#nganhang').val(result.options);
        $('#nganhang').empty();
        $('#nganhang').append(result.options);
        //$('#DVT').val(result.tenDVT);
      },
      error: function () {
        alert("Failhu");
      }
    });
  }

  //okk
  function loadTablePQ(id) {
    $('#taikhoan').val(id);
    $.ajax({
      type: "post",
      url: "/loadTablePQ",
      data: "idtk=" + id,
      success: function (result) {
        $('#phanquyen').replaceWith(result);
        changeCancel();
        changeAdd();
      },
      error: function () {
        alert("Failhuhu");
      }
    });
  }



  //okk
  $('#search').keyup(function () {
    var key = $(this).val();
    $.ajax({
      type: "post",
      url: "/searchTableNV",
      data: "key=" + key,
      success: function (result) {
        $('#taikhoan').replaceWith(result);
      },
      error: function () {
        alert("Faill11122");
      }
    });
  });

  //okk
  $(function () {
    $(".add_new").click(function () {
      $.ajax({
        type: "post",
        url: "/addNewRowPQ",
        success: function (result) {
          $("#phanquyen").prepend(result)
          changeCancel();
        },
        error: function () {
          alert("Failllllll");
        }
      });
    });

    //okk
    $("#myTable").on("click", ".btn-secondary", function () {
      var id = $('#taikhoan').val();
      $.ajax({
        type: "post",
        url: "/loadTablePQ",
        data: "idtk=" + id,
        success: function (result) {
          $('#phanquyen').replaceWith(result);
          changeAdd();
        },
        error: function () {
          alert("Failhuhu");
        }
      });
    });

    //okk
    $("#myTable").on("click", ".add", function () {
      var idtk = $('#taikhoan').val();
      var idcn = $('#idcn').val();
      var idvt = $('#idvt').val();
      $.ajax({
        type: "post",
        url: "/AddPQ",
        data: "idcn=" + idcn + "&idtk=" + idtk + "&idvt=" + idvt,
        success: function (result) {
          if (result == "Thêm thành công") {
            loadTablePQ(idtk);
          }
          alert(result);
        },
        error: function () {
          alert("Fail222");
        }
      });
    });


    //okk
    $("#myTable").on("click", ".remove", function () {
      if (confirm('Bạn có muốn xoá?')) {
        var idtk = $('#taikhoan').val();
        var id = $(this).attr("value");
        $.ajax({
          type: "post",
          url: "/removePQ",
          data: "id=" + id,
          success: function (result) {
            loadTablePQ(idtk);
            alert(result);
          },
          error: function () {
            alert("Fail");
          }
        });
      }
    });

    //okk
    $("#myTable").on("click", ".edit", function () {
      var idpq = $(this).parents('tr').find("td:eq(0) input[type='hidden']").val();
      $('#idpq').val(idpq);
      var thiss = $(this);
      $.ajax({
        type: "post",
        url: "/addNewRowPQ",
        data: "idpq=" + idpq,
        success: function (result) {
          thiss.parents('tr').replaceWith(result);
          loadPQCN();
        },
        error: function () {
          alert("Failload");
        }
      });
    });

    //okk
    $("#myTable").on("click", ".savepq", function () {
      var idtk = $('#taikhoan').val();
      var idpq = $(this).parents('tr').find("td:eq(0) input[type='hidden']").val();
      var idcn = $(this).parents('tr').find("td:eq(0) select").val();
      var idvt = $(this).parents('tr').find("td:eq(1) select").val();
      $.ajax({
        type: "post",
        url: "/updatepq",
        data: "idpq=" + idpq + "&idcn=" + idcn + "&idvt=" + idvt,
        success: function (result) {
          loadTablePQ(idtk);
          alert(result);
        },
        error: function () {
          alert("Fail222");
        }
      });
    });


  });

  //okk
 


</script>